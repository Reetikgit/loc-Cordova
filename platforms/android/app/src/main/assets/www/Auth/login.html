<!DOCTYPE html>
<html lang="en">

<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <link rel="stylesheet" href="https://cdn.metroui.org.ua/v4.3.2/css/metro-all.min.css">
  <meta name="keywords" content="Lake">
  <meta name="author" content="GeniusOcean">
  <title>Online Cake Delivery | #1 Online Cake,Flowers & Gifts in Lucknow | Lake of Cakes | Login</title>

  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->

  <script type="text/javascript" charset="utf-8" src="../cordova.js"></script>
  <!-- New Navbar Link -->
  <!-- <script type="text/javascript" charset="utf-8" src="cordova.js"></script> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="mega-menu.css">
  <!-- <link rel="icon" type="image/x-icon" href="//lakeofcakes.com/assets/images/1596886304logo for favicon.PNG" /> -->


  <meta name="theme-color" content="#a15a55">
  <link href="../assets/css/login.css" rel="stylesheet" type="text/css" media="screen" />

  <link type="text/css" rel="stylesheet" href="firebaseui.css" />

  <link rel="manifest" href="manifest.json">


</head>
<style>
  /* The Modal (background) */
  .modal {
    display: none;
    /* Hidden by default */
    position: fixed;
    /* Stay in place */
    z-index: 1;
    /* Sit on top */
    left: 0;
    top: 0;
    width: 100%;
    /* Full width */
    height: 100%;
    /* Full height */
    overflow: auto;
    /* Enable scroll if needed */
    background-color: rgb(0, 0, 0);
    /* Fallback color */
    background-color: rgba(0, 0, 0, 0.4);
    /* Black w/ opacity */
    -webkit-animation-name: fadeIn;
    /* Fade in the background */
    -webkit-animation-duration: 0.4s;
    animation-name: fadeIn;
    animation-duration: 0.4s
  }

  /* Modal Content */
  .modal-content {
    position: fixed;
    bottom: 0;
    background-color: #fefefe;
    width: 100%;
    -webkit-animation-name: slideIn;
    -webkit-animation-duration: 0.4s;
    animation-name: slideIn;
    animation-duration: 0.4s
  }

  /* The Close Button */
  .close {
    color: white;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .close:hover,
  .close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
  }

  .modal-header {
    padding: 2px 16px;
    background-color: #bd3716;
    color: white !important;
  }

  .modal-body {
    padding: 2px 16px;
  }

  .modal-footer {
    padding: 2px 16px;
    background-color: #df4415;
    color: white;
  }

  /* Add Animation */
  @-webkit-keyframes slideIn {
    from {
      bottom: -300px;
      opacity: 0
    }

    to {
      bottom: 0;
      opacity: 1
    }
  }

  @keyframes slideIn {
    from {
      bottom: -300px;
      opacity: 0
    }

    to {
      bottom: 0;
      opacity: 1
    }
  }

  @-webkit-keyframes fadeIn {
    from {
      opacity: 0
    }

    to {
      opacity: 1
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0
    }

    to {
      opacity: 1
    }
  }
</style>
</style>

<body style="overflow-x: hidden !important; ">


  <section class="w3l-workinghny-form">
    <!-- /form -->
    <div class="workinghny-form-grid">
      <div class="wrapper">
        <div class="logo">
          <!-- <h1><a class="brand-logo" href="index.html"><span>Hi !!</span>Guest</a></h1> -->
          <img src="../assets/images/logo.png" alt="" style="width: 400px;object-fit: contain;">
          <!-- if logo is image enable this   
                        <a class="brand-logo" href="#index.html">
                            <img src="image-path" alt="Your logo" title="Your logo" style="height:35px;" />
                        </a> -->
        </div>
        <div class="workinghny-block-grid">

          <div class="workinghny-left-img ">

            <div id="loading"></div>
            <div id="loaded" class="hidden">
              <div id="main">
                <div id="user-signed-in" class="hidden">
                  <div id="user-info" style="display: none
                              ;">
                    <div id="photo-container">
                      <img id="photo">
                    </div>
                    <div id="name"></div>
                    <div id="email"></div>
                    <div id="phone"></div>
                    <div id="is-new-user"></div>
                    <div class="clearfix"></div>
                  </div>
                  <p>
                    <button id="sign-out" style="display: none;">Sign Out</button>
                    <button id="delete-account" style="display: none;">Delete account</button>
                  </p>
                </div>
                <div id="user-signed-out" class="hidden">

                  <fieldset>

                    <div id="firebaseui-spa">
               
                      <div id="firebaseui-container" style="text-align: center;">
                        <button class="btn btn-style" onclick="redirectToBrowser()" style="background-color:white;color: black;padding: 5px;"><i class="fa fa-google-plus" style="color: red;float: left;font-size: 25px;padding-left: 10px;"></i> &nbsp;Sign in with Google </i></button>
                      </div>
                    </div>
                </div>
              </div>
            </div>


          </div>
          <div class="form-right-inf">

            <div class="login-form-content">
              <h2 style="text-align: center;padding: 10px !important;">Login</h2>

              <div class="one-frm">

                <label>Email</label>
                <input type="email" name="Name" id="email2" placeholder="" required="">
              </div>
              <div class="one-frm">
                <label>Password</label>
                <input type="password" name="Password" id="password" placeholder="" required="">
              </div>
              <!-- <label class="check-remaind">
                                    <input type="checkbox">
                                    <span class="checkmark"></span>
                                    <p class="remember">Remember Me</p>

                                </label> -->
              <button class="btn btn-style mt-3" id="log">Sign In </button>
              <p class="already">Don't have an account? <a href="signup.html">Sign Up</a></p>
              <a style="cursor: pointer; " data-toggle="modal" data-target="#forgot">
                <p class="already" style="font-weight: 700;font-size: 14px;" id="myBtn">Forgot Password?</p>
              </a>
            </div>
          </div>
        </div>
      </div>
      <!-- The Modal -->
      <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
          <div class="modal-header">
            <span class="close">&times;</span>
            <!-- <h2 style="color: #ffffff;">Modal Header</h2> -->
          </div>
          <div class="modal-body">
            <div class="form-gap"></div>
            <div class="container">
              <div class="row">
                <div class="col-md-4 col-md-offset-4">
                  <div class="panel panel-default">
                    <div class="panel-body">
                      <div class="text-center">
                        <h3><i class="fa fa-lock fa-4x"></i></h3>
                        <h2 class="text-center">Forgot Password?</h2>
                        <p>You can reset your password here.</p>
                        <div class="panel-body">


                          <div class="form-group" id="sendCode">
                            <div class="input-group">
                              <span class="input-group-addon"><i
                                  class="glyphicon glyphicon-envelope color-blue"></i></span>
                              <input id="emailF" name="email" placeholder="Enter your Email address"
                                class="form-control" type="email">
                            </div>

                            <div class="form-group">
                              <button style="padding: 10px;background-color: brown;color:#ffffff;margin-bottom: 4%;"
                                onclick="sendCode()" type="submit">Send
                                Code</button>
                            </div>
                          </div>
                          <input type="hidden" class="hide" name="token" id="token" value="">

                          <div class="form-group" id="verifyCode" style="display: none;">

                            <div class="input-group">
                              <span class="input-group-addon"><i
                                  class="glyphicon glyphicon-envelope color-blue"></i></span>
                              <input id="otp" name="otp" placeholder="Enter OTP sent on mail" class="form-control"
                                type="otp">
                            </div>

                            <input type="hidden" class="hide" name="token" id="token" value="">
                            <div class="form-group">
                              <button style="padding: 10px;background-color: brown;color:#ffffff" type="submit"
                                onclick="verifyOtp()"> Verify</button>
                            </div>
                          </div>
                          <div class="form-group" id="resetCode" style="display: none;">
                            <div class="input-group">
                              <span class="input-group-addon"><i
                                  class="glyphicon glyphicon-envelope color-blue"></i></span>
                              <input id="Pass" name="pass" placeholder="New Password" class="form-control"
                                type="password">
                            </div>
                            <div class="input-group">
                              <span class="input-group-addon"><i
                                  class="glyphicon glyphicon-envelope color-blue"></i></span>
                              <input id="cPass" name="email" placeholder="Repeat Password" class="form-control"
                                type="password">
                            </div>

                            <div class="form-group">
                              <button style="padding: 10px;background-color: brown;color:#ffffff" type="submit"
                                onclick="updatePassword()">Update
                                Password</button>
                            </div>

                            <input type="hidden" class="hide" name="token" id="token" value="">

                          </div>
                          <h4 id="logs" style="padding: 20px;color:red;display: none;">Invalid Credentials</h4>



                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- <div class="modal-footer">
              <h3>Modal Footer</h3>
            </div> -->
        </div>

      </div>
      <!-- <div class="bottomtotop">
        <i class="fas fa-chevron-right"></i>
      </div> -->
      
</body>
<script src="https://www.gstatic.com/firebasejs/7.4.0/firebase.js"></script>
<script src="config.js"></script>
<!-- <script src="common.js"></script>
<script src="firebaseui.js"></script>
<script src="app.js"></script> -->
<script>
  // redirectToBrowser();
  const dbs = firebase.firestore();
  dbs.collection("Customers").onSnapshot((snapshot) => {

    let snapshotDocs = snapshot.docs;
    document.getElementById("log").addEventListener("click", async function () {


      let email = document.querySelector('#email2').value;
      let password = document.querySelector('#password').value;
      var k;
      var count = 0;
      for (let i of snapshotDocs) {

        var doc = i.data();
        if (doc.Password == undefined) {
          continue;
        }
        if ((doc.Email).toUpperCase() == email.toUpperCase() && atob(doc.Password) == password) {
          count++;
          key = i;
          break;
        }
      }
      if (count == 1) {
        document.getElementById("log").innerHTML = "Welcome Back" + " " + key.data().UserName;
        document.getElementById("log").style.backgroundColor = "green"
        let token = btoa(key.data().id + "Online" + doc.Email)
        let userRef = await dbs.collection("Customers").doc(key.data().userId);
        await userRef.update("token", token)
        window.localStorage.setItem("locLoggedInUser", key.data().userId)
        ////////////////////////////////////////////////////////////////////
        let uId = window.localStorage.getItem('locLoggedInUser');
        let buyNowProd = window.sessionStorage.getItem('buyNowProd');
        if (buyNowProd) {
          // let uRef = db.collection('Customers').doc(uId);
          userRef.get().then(async (udoc) => {
            let udata = udoc.data();
            buyNowProd = JSON.parse(buyNowProd);
            if (udata.orders) {
              udata.orders.push(buyNowProd);
            } else {
              let orders = [];
              orders.push(buyNowProd);
              udata.orders = orders;
            }
            await userRef.update(udata);
            let orderId = buyNowProd.orderId;
            await sessionStorage.removeItem("buyNowProd");
            window.open=cordova.InAppBrowser.open(`https://lakeofcakes.com/Payment/checkout.html?checkout=${orderId}&&user=${checkUser}`, `_blank`, `location=no`);
            
            // window.location = `../Payment/checkout.html?checkout=${orderId}`;
          })
        } else {
          setTimeout(function () {
          let goTo = window.localStorage.getItem("redirectURL");
          if (goTo != null && (goTo != "null"))
            if (goTo == "index.html") {
              window.location = "../index.html"
            } else {
              window.location = goTo;
            }
          else
            window.location = "../index.html"
        }, 100)
        }
      } else {
        document.getElementById("log").innerHTML = "Invalid Credentials"
        document.getElementById("log").style.backgroundColor = 'red'
        setTimeout(function () {
          document.getElementById("log").innerHTML = "Login"
          document.getElementById("log").style.backgroundColor = '#4361ee'
        }, 2000)
      }
    });
  })

  var modal = document.getElementById("myModal");

  // Get the button that opens the modal
  var btn = document.getElementById("myBtn");

  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[0];

  // When the user clicks the button, open the modal 
  btn.onclick = function () {
    modal.style.display = "block";
  }

  // When the user clicks on <span> (x), close the modal
  span.onclick = function () {
    modal.style.display = "none";
  }

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function (event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

  function sendCode() {
    let count = 0;
    let went = 0;
    let email = document.querySelector('#emailF').value;
    const dbs = firebase.firestore();
    dbs.collection("Customers").get().then(async (snapshot) => {


      let key;

      let snapshotDocs = snapshot.docs;
      for (let i of snapshotDocs) {

        var doc = i.data();
        if (doc.Email == undefined) {
          continue;
        }
        if ((doc.Email).toUpperCase() == email.toUpperCase()) {
          count++;
          key = i;
          break;
        }
      }

      if (count == 1) {
      
        let randomcode = Math.floor(Math.random() * 90000) + 10000;

        await dbs.collection("Customers").doc(key.data().userId).update("forgotCode", randomcode)

        setTimeout(function () {
          document.getElementById("sendCode").style.display = "none"
          document.getElementById("verifyCode").style.display = "block"
          count = 0;
        }, 100)


      } else {


        document.getElementById("logs").style.display = "block"
        document.getElementById("logs").innerHTML = "Email Id not found"

        setTimeout(function () {
          document.getElementById("logs").style.display = "none"
        }, 2000)


      }
    });

  }
  var global;
  function verifyOtp() {
    let went = 0;
    let count = 0;
    let wents = 0;
    let otp = document.querySelector('#otp').value;
    let key;

    const dbs = firebase.firestore();
    dbs.collection("Customers").get().then(async (snapshot) => {
      let snapshotDocs = snapshot.docs;
      for (let i of snapshotDocs)  {

        var doc = i.data();
        if (doc.forgotCode == undefined) {
          continue;
        }
        if ((doc.forgotCode) == otp) {
          count++;
          key = i;
          global = i;
          break;
        }
      }

      if (count == 1) {
        wents++;
        let randomcode = Math.floor(Math.random() * 90000) + 10000;

        await dbs.collection("Customers").doc(key.data().userId).update("forgotCode", "verified")

        setTimeout(function () {
          document.getElementById("verifyCode").style.display = "none"
          document.getElementById("resetCode").style.display = "block"
          count = 0;
        }, 100)


      } else {
        if (wents == 0) {

          document.getElementById("logs").style.display = "block"
          document.getElementById("logs").innerHTML = "Invalid Otp"

          setTimeout(function () {
            document.getElementById("logs").style.display = "none"
          }, 2000)
        }

      }
    });

  }
  function updatePassword() {
    let went = 0;
    let wents = 0;
    let pass = document.querySelector('#Pass').value
    let cpass = document.querySelector('#cPass').value
    if (pass) {
      if (cpass) {
        if (pass == cpass) {
          newpass = btoa(pass)
          dbs.collection("Customers").doc(global.data().userId).update("Password", newpass)
          document.getElementById("logs").style.display = "block"
          document.getElementById("logs").style.backgroundColor="green"
          document.getElementById("logs").innerHTML = "Password Updated Sucessfully"

          setTimeout(function () {
            window.location.reload();
          }, 2000)
        }
      }
    }
  }
  function redirectToBrowser(){

//     cordova.plugins.firebase.messaging.getToken().then(function(token) {
//     console.log("Got device token: ", token);
//     alert(token)
// });
  
    // window.FirebasePlugin.getToken(function(token){
    //     sendtoken=token;
      
    //   });
    // window.open = cordova.InAppBrowser.open;
  // scordova.InAppBrowser.open('https://lakeofcakes.com/Auth/login.html', '_blank', 'location=no');
    // window.open = c
    window.plugins.googleplus.login({
      
     // optional, but requires the webClientId - if set to true the plugin will also return a serverAuthCode, which can be used to grant offline access to a non-Google server
},  function (obj) {
  


      var counter=0;
      db.collection("Customers").onSnapshot(async (snapshots) => {

    
      let snapshotDocs = snapshots.docs;
      var dbref = db.collection('Customers');
      let USER_DATA;
      for (let doc of snapshotDocs) {
        // alert(6)
        let docData = doc.data();
        USER_DATA = docData;
    //     cordova.plugins.firebase.messaging.getToken().then(function(token) {
    // console.log("Got device token: ", token);
    // alert(token)
// });
        if (docData.Email == obj.email) {
          // window.FirebasePlugin.getToken(function(token){
          // var sendtoken=token;
          
          // });
          await dbref.doc(doc.id).update({
            UserName: obj.displayName,
            Email: obj.email,
            Image: obj.imageUrl,
            UserAuthID: obj.userId,
            userId:doc.id,
            token:btoa(obj.email),
            // androidUserToken:sendtoken
          });
          window.localStorage.setItem("locLoggedInUser",doc.id)
          counter++;
      
          // user ? handleSignedInUser(user) : handleSignedOutUser();
          let goTo=window.localStorage.getItem("redirectURL");
         
          if(goTo!=null &&(goTo!="null")){
            if(goTo=="index.html"){
              window.location="../index.html"
            }else if(goTo.includes("product.html")){
             
              let buyNowProd = window.sessionStorage.getItem('buyNowProd');
              alert(buyNowProd)
              if(buyNowProd) {
              
                buyNowProd = JSON.parse(buyNowProd);
                if(USER_DATA.orders) {
                  USER_DATA.orders.push(buyNowProd);
                } else {
                  let orders = [];
                  orders.push(buyNowProd);
                  USER_DATA.orders = orders;
                }
                await dbref.doc(doc.id).update(USER_DATA);
                let orderId = buyNowProd.orderId;
              // sessionStorage.removeItem("buyNowProd");
                window.open=cordova.InAppBrowser.open(`https://lakeofcakes.com/Payment/checkout.html?checkout=${orderId}&&user=${checkUser}`, `_blank`, `location=no`);
                // window.location = `../Payment/checkout.html?checkout=${orderId}`;
                // console.log(doc.data());
                // let userRef = await db.collection("Customers").doc(userId);
              }else{
               
                window.location=goTo;
              }
             
            }else{
              
               window.location=goTo;
            }
        
          }
 
          else{
   
            window.location="../index.html"
          }
         
          break;
         
         
        }else{
          
          var setWithMerge = dbref.add({
            UserName: obj.displayName,
            Email: obj.email,
            Image: obj.imageUrl,
            UserAuthID: obj.userId,
            userId:doc.id,
            token:btoa(obj.email),
        });
        }

      }
      if (counter == 0) {
        if(obj.Email==null ||obj.Email=="null"){
          obj.Email=""
        }
        var setWithMerge = dbref.add({
          userName: obj.displayName,
          Email: obj.email,
          Image: obj.imageUrl,
          createdDtm: firebase.firestore.FieldValue.serverTimestamp(),
          lastLoginTime: firebase.firestore.FieldValue.serverTimestamp(),
          token:"newuser",
          Phone :obj.phoneNumber
        });
     

      }
    });
      // do something useful instead of alerting
    },
    function (msg) {
      alert('error: ' + msg);
    });
  }
</script>
<script src="./login1.js"></script>
</html>